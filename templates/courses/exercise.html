{% extends "base.html" %}

{% block title %}Exercise {{ index|add:1 }} of {{ total }} – {{ course.title }}{% endblock %}

{% block content %}
<div class="exercise-viewport">
<p class="exercise-breadcrumb"><a href="{% url 'courses:detail' course.slug %}">{{ course.title }}</a> – Exercise {{ index|add:1 }} of {{ total }}</p>

<div class="card exercise-card" id="exercise-anchor">
    <div class="exercise-progress-bar-wrap">
        <div class="progress-bar">
            <div class="progress-bar-fill" style="width: {% widthratio index|add:1 total 100 %}%"></div>
        </div>
        <p class="exercise-progress-label">Exercise {{ index|add:1 }} of {{ total }}</p>
    </div>
    <h2 class="exercise-question">{{ exercise.question }}</h2>

    {% if exercise.exercise_type == "multiple_choice" %}
    {% if answered %}
    <ul class="exercise-options option-list exercise-options-answered">
        {% for option in exercise.payload.options %}
        <li class="option-card {% if forloop.counter0 == selected_answer %}option-card-selected{% endif %}">
            <span class="option-text">{{ option }}</span>
            {% if forloop.counter0 == selected_answer %}<span class="option-your-answer">Your answer</span>{% endif %}
        </li>
        {% endfor %}
    </ul>
    {% if index|add:1 < total %}
    <a href="{% url 'courses:exercise' course.slug index|add:1 %}" class="btn-primary exercise-action-btn">Next exercise</a>
    {% else %}
    <a href="{% url 'courses:detail' course.slug %}" class="btn-primary exercise-action-btn">Back to course</a>
    {% endif %}
    {% else %}
    <form method="post" action="">
        {% csrf_token %}
        <ul class="exercise-options option-list">
            {% for option in exercise.payload.options %}
            <li class="option-card">
                <label>
                    <input type="radio" name="answer" value="{{ forloop.counter0 }}" required>
                    <span class="option-text">{{ option }}</span>
                </label>
            </li>
            {% endfor %}
        </ul>
        <button type="submit" class="btn-primary exercise-action-btn">Submit</button>
    </form>
    {% endif %}

    {% elif exercise.exercise_type == "matching_pairs" %}
    {% if answered %}
    <div class="mb-4">
        {% for row in matching_result %}
        <div class="matching-answered-row">
            <div class="matching-answered-cell {% if row.is_correct %}correct{% else %}wrong{% endif %}">
                <span class="matching-left">{{ row.left }}</span>
            </div>
            <div>
                <div class="matching-answered-cell {% if row.is_correct %}correct{% else %}wrong{% endif %}">
                    {{ row.user_right }}
                </div>
                {% if not row.is_correct %}
                <p class="matching-answered-correct-answer">Correct: {{ row.correct_right }}</p>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% if index|add:1 < total %}
    <a href="{% url 'courses:exercise' course.slug index|add:1 %}" class="btn-primary exercise-action-btn">Next exercise</a>
    {% else %}
    <a href="{% url 'courses:detail' course.slug %}" class="btn-primary exercise-action-btn">Back to course</a>
    {% endif %}
    {% else %}
    <form method="post" action="" id="matching-form">
        {% csrf_token %}
        {% for left in left_items %}
        <input type="hidden" name="match_{{ forloop.counter0 }}" id="match-input-{{ forloop.counter0 }}">
        {% endfor %}
        <div class="matching-columns">
            <div class="matching-col" id="left-col">
                {% for left in left_items %}
                <div class="matching-tile"
                     data-side="left"
                     data-index="{{ forloop.counter0 }}">{{ left }}</div>
                {% endfor %}
            </div>
            <div class="matching-col" id="right-col">
                {% for opt_val, opt_label in right_options %}
                <div class="matching-tile"
                     data-side="right"
                     data-value="{{ opt_val }}">{{ opt_label }}</div>
                {% endfor %}
            </div>
        </div>
        <button type="submit" class="btn-primary exercise-action-btn" id="matching-submit" disabled>Submit</button>
    </form>
    <script>
    (function () {
        var total = {{ left_items|length }};
        var selectedLeft = null;
        var matchedCount = 0;

        document.querySelectorAll('.matching-tile[data-side="left"]').forEach(function (tile) {
            tile.addEventListener('click', function () {
                if (tile.classList.contains('matched')) return;
                if (selectedLeft && selectedLeft !== tile) {
                    selectedLeft.classList.remove('selected');
                }
                if (selectedLeft === tile) {
                    tile.classList.remove('selected');
                    selectedLeft = null;
                } else {
                    tile.classList.add('selected');
                    selectedLeft = tile;
                }
            });
        });

        document.querySelectorAll('.matching-tile[data-side="right"]').forEach(function (tile) {
            tile.addEventListener('click', function () {
                if (!selectedLeft) return;
                if (tile.classList.contains('matched')) return;
                var leftIdx = parseInt(selectedLeft.dataset.index, 10);
                var rightVal = parseInt(tile.dataset.value, 10);
                if (rightVal === leftIdx) {
                    selectedLeft.classList.remove('selected');
                    selectedLeft.classList.add('matched');
                    tile.classList.add('matched');
                    document.getElementById('match-input-' + leftIdx).value = rightVal;
                    selectedLeft = null;
                    matchedCount += 1;
                    if (matchedCount === total) {
                        document.getElementById('matching-submit').disabled = false;
                    }
                } else {
                    selectedLeft.classList.add('wrong');
                    tile.classList.add('wrong');
                    var leftTile = selectedLeft;
                    selectedLeft = null;
                    setTimeout(function () {
                        leftTile.classList.remove('wrong', 'selected');
                        tile.classList.remove('wrong');
                    }, 700);
                }
            });
        });
    })();
    </script>
    {% endif %}
    {% endif %}

    {% if answered %}
    <div class="exercise-feedback">
        <p class="feedback-message {% if correct %}feedback-correct{% else %}feedback-incorrect{% endif %}">
            {% if correct %}Correct!{% else %}Not quite.{% endif %}
        </p>
        {% if explanation %}
        <div class="explanation-block">
            <h3>Explanation</h3>
            <p>{{ explanation }}</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
</div>
{% endblock %}
