{% extends "base.html" %}

{% block title %}Flashcards – {{ course.title }} – CourseForge{% endblock %}

{% block content %}
<div class="page-header">
    <h1 class="page-header-title">{{ course.title }}</h1>
    <p class="page-header-meta">
        <i class="fa-solid fa-clone" aria-hidden="true"></i>
        {{ total_flashcards }} flashcard{{ total_flashcards|pluralize }}
    </p>
</div>

<section class="card card-spaced flashcards-wrapper">
    {% if not flashcards %}
    <p>No flashcards are available for this course yet.</p>
    <p><a href="{% url 'courses:detail' course.slug %}">&larr; Back to course</a></p>
    {% else %}
    <header class="flashcards-header">
        <div class="flashcards-counter">
            Card <span id="flashcard-current-index">1</span> of <span id="flashcard-total">{{ total_flashcards }}</span>
        </div>
    </header>

    <div class="flashcard-stage">
        <div class="flashcard-card" id="flashcard-card" aria-live="polite">
            <div class="flashcard-card-inner" id="flashcard-card-inner">
                <div class="flashcard-face flashcard-face-front" id="flashcard-front">
                    {{ flashcards.0.front }}
                </div>
                <div class="flashcard-face flashcard-face-back" id="flashcard-back">
                    {{ flashcards.0.back }}
                </div>
            </div>
        </div>
    </div>

    <div class="flashcards-controls">
        <button type="button" id="flashcard-prev" class="btn-secondary" aria-label="Previous card">
            &larr; Previous
        </button>
        <button type="button" id="flashcard-next" class="btn-secondary" aria-label="Next card">
            Next &rarr;
        </button>
    </div>

    <p class="flashcards-back-link">
        <a href="{% url 'courses:detail' course.slug %}">&larr; Back to course overview</a>
    </p>

    <script>
        (function () {
            const data = [
                {% for card in flashcards %}
                {
                    front: "{{ card.front|escapejs }}",
                    back: "{{ card.back|escapejs }}"
                }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            const total = data.length;
            let index = 0;
            let isTransitioning = false;

            const card = document.getElementById("flashcard-card");
            const cardInner = document.getElementById("flashcard-card-inner");
            const frontEl = document.getElementById("flashcard-front");
            const backEl = document.getElementById("flashcard-back");
            const currentIndexEl = document.getElementById("flashcard-current-index");
            const totalEl = document.getElementById("flashcard-total");
            const prevBtn = document.getElementById("flashcard-prev");
            const nextBtn = document.getElementById("flashcard-next");

            if (!card || !cardInner || !frontEl || !backEl || !currentIndexEl || !totalEl) {
                return;
            }

            totalEl.textContent = total.toString();

            function render() {
                const item = data[index];
                frontEl.textContent = item.front;
                backEl.textContent = item.back;
                currentIndexEl.textContent = (index + 1).toString();
            }

            function flip() {
                if (isTransitioning) {
                    return;
                }
                cardInner.classList.toggle("is-flipped");
            }

            function go(delta) {
                if (!total || isTransitioning) {
                    return;
                }

                isTransitioning = true;

                const outClass = delta > 0 ? "slide-out-left" : "slide-out-right";
                const inClass = delta > 0 ? "slide-in-right" : "slide-in-left";
                const outDuration = 350;
                const inDuration = 350;

                card.classList.remove("slide-out-left", "slide-out-right", "slide-in-left", "slide-in-right");
                card.classList.add(outClass);

                // After the old card has slid out, change the content while off-screen,
                // reset to the front side, then slide the new card in.
                setTimeout(function () {
                    index = (index + delta + total) % total;
                    cardInner.classList.remove("is-flipped");
                    render();

                    card.classList.remove(outClass);
                    card.classList.add(inClass);

                    setTimeout(function () {
                        card.classList.remove(inClass);
                        isTransitioning = false;
                    }, inDuration);
                }, outDuration);
            }

            card.addEventListener("click", function () {
                flip();
            });

            if (prevBtn) {
                prevBtn.addEventListener("click", function () {
                    go(-1);
                });
            }

            if (nextBtn) {
                nextBtn.addEventListener("click", function () {
                    go(1);
                });
            }

            render();
        })();
    </script>

    <style>
        .flashcards-wrapper {
            text-align: center;
        }

        .flashcards-header {
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .flashcard-stage {
            perspective: 1200px;
            margin: 1.5rem auto;
            max-width: 520px;
        }

        .flashcard-card {
            cursor: pointer;
        }

        .flashcard-card-inner {
            position: relative;
            width: 100%;
            min-height: 210px;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
        }

        .flashcard-card-inner.is-flipped {
            transform: rotateY(180deg);
        }

        .flashcard-face {
            position: absolute;
            inset: 0;
            backface-visibility: hidden;
            border-radius: 0.8rem;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            background: rgba(15, 23, 42, 0.85);
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.45);
            transition: opacity 0.3s ease;
        }

        .flashcard-face-front {
            border: 1px solid rgba(96, 165, 250, 0.7);
        }

        .flashcard-face-back {
            transform: rotateY(180deg);
            border: 1px solid rgba(52, 211, 153, 0.7);
        }

        .flashcard-card-inner.is-flipped .flashcard-face-front {
            opacity: 0;
        }

        .flashcard-card-inner.is-flipped .flashcard-face-back {
            opacity: 1;
        }

        .flashcards-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .flashcards-back-link {
            margin-top: 1.5rem;
        }

        .flashcard-card.slide-out-left {
            animation: flashcard-slide-out-left 0.35s forwards;
        }

        .flashcard-card.slide-out-right {
            animation: flashcard-slide-out-right 0.35s forwards;
        }

        .flashcard-card.slide-in-right {
            animation: flashcard-slide-in-right 0.35s forwards;
        }

        .flashcard-card.slide-in-left {
            animation: flashcard-slide-in-left 0.35s forwards;
        }

        @keyframes flashcard-slide-out-left {
            0% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateX(-80%) scale(0.95);
                opacity: 0;
            }
        }

        @keyframes flashcard-slide-out-right {
            0% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateX(80%) scale(0.95);
                opacity: 0;
            }
        }

        @keyframes flashcard-slide-in-right {
            0% {
                transform: translateX(80%) scale(0.95);
                opacity: 0;
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes flashcard-slide-in-left {
            0% {
                transform: translateX(-80%) scale(0.95);
                opacity: 0;
            }
            100% {
                transform: translateX(0) scale(1);
                opacity: 1;
            }
        }

        @media (max-width: 600px) {
            .flashcard-card-inner {
                min-height: 180px;
                padding: 1.25rem;
            }
        }
    </style>
    {% endif %}
</section>
{% endblock %}

