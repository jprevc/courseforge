{% load static %}
<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="{% block meta_description %}CourseForge – Create AI-powered courses and master new skills through guided exercises.{% endblock %}">
    <title>{% block title %}CourseForge{% endblock %}</title>
    <link rel="icon" href="{% static 'images/courseforge_logo.png' %}" type="image/png">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" crossorigin="anonymous">
    <link rel="stylesheet" href="{% static 'css/theme.css' %}">
    {% block extra_head %}{% endblock %}
</head>
<body class="{% if request.resolver_match.namespace == 'courses' and request.resolver_match.url_name == 'exercise' or request.resolver_match.namespace == 'courses' and request.resolver_match.url_name == 'flashcards' %}exercise-mode{% endif %}">
    <header class="site-header">
        <nav class="container">
            <ul class="nav-left">
                <li><a href="{% url 'home' %}" class="nav-logo" {% if request.resolver_match.url_name == 'home' and not request.resolver_match.namespace %}aria-current="page"{% endif %}>
                    <img src="{% static 'images/courseforge_logo.png' %}" alt="CourseForge – Create. Share. Learn." height="56" width="auto">
                </a></li>
            </ul>
            {% if user.is_authenticated %}
            <ul class="nav-center">
                <li><a href="{% url 'dashboard' %}" {% if request.resolver_match.url_name == 'dashboard' %}aria-current="page"{% endif %}><i class="fa-solid fa-gauge nav-icon" aria-hidden="true"></i><span class="nav-link-text">Dashboard</span></a></li>
                <li><a href="{% url 'courses:list' %}" {% if request.resolver_match.namespace == 'courses' and request.resolver_match.url_name == 'list' %}aria-current="page"{% endif %}><i class="fa-solid fa-book nav-icon" aria-hidden="true"></i><span class="nav-link-text">Browse courses</span></a></li>
                <li><a href="{% url 'courses:create' %}" {% if request.resolver_match.namespace == 'courses' and request.resolver_match.url_name == 'create' %}aria-current="page"{% endif %}><i class="fa-solid fa-plus nav-icon" aria-hidden="true"></i><span class="nav-link-text">Create course</span></a></li>
            </ul>
            <ul class="nav-right">
                <li class="nav-notifications">
                    <button class="notif-bell" id="notif-bell-btn" aria-label="Notifications">
                        <i class="fa-solid fa-bell" aria-hidden="true"></i>
                        <span class="notif-badge" id="notif-badge" hidden>0</span>
                    </button>
                    <div class="notif-dropdown" id="notif-dropdown" hidden>
                        <div class="notif-list" id="notif-list"></div>
                        <button type="button" id="notif-mark-read">Mark all as read</button>
                    </div>
                </li>
                <li class="nav-user-dropdown">
                    <button class="nav-username" id="user-menu-btn" aria-expanded="false" aria-haspopup="true">
                        <i class="fa-solid fa-user nav-icon" aria-hidden="true"></i>
                        <span class="nav-username-text">{{ user.username }}</span>
                        <i class="fa-solid fa-chevron-down nav-chevron" aria-hidden="true"></i>
                    </button>
                    <div class="user-dropdown" id="user-dropdown" hidden>
                        <form method="post" action="{% url 'logout' %}" class="inline-form">
                            {% csrf_token %}
                            <button type="submit"><i class="fa-solid fa-right-from-bracket" aria-hidden="true"></i> Log out</button>
                        </form>
                    </div>
                </li>
            </ul>
            {% else %}
            <ul class="nav-right">
                <li><a href="{% url 'login' %}" {% if request.resolver_match.url_name == 'login' %}aria-current="page"{% endif %}>Log in</a></li>
                <li><a href="{% url 'register' %}" role="button" {% if request.resolver_match.url_name == 'register' %}aria-current="page"{% endif %}>Register</a></li>
            </ul>
            {% endif %}
        </nav>
    </header>
    <main class="container">
        {% if messages %}
        <ul class="messages" role="status">
            {% for message in messages %}
            <li class="message {% if message.tags %}message-{{ message.tags }}{% endif %}">{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}
        {% block content %}{% endblock %}
    </main>
    <footer class="site-footer">
        <p>&copy; {% now "Y" %} CourseForge &mdash; <a href="{% url 'home' %}">Home</a> &middot; <a href="{% url 'courses:list' %}">Browse Courses</a></p>
    </footer>
    {% if user.is_authenticated %}
    <script>
    (function () {
        const bellBtn = document.getElementById("notif-bell-btn");
        const badge = document.getElementById("notif-badge");
        const dropdown = document.getElementById("notif-dropdown");
        const list = document.getElementById("notif-list");
        const markAllBtn = document.getElementById("notif-mark-read");

        if (!bellBtn || !badge || !dropdown || !list || !markAllBtn) {
            return;
        }

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) {
                return parts.pop().split(";").shift();
            }
            return null;
        }

        function renderNotifications(data) {
            const count = data && typeof data.count === "number" ? data.count : 0;

            if (count > 0) {
                badge.hidden = false;
                badge.textContent = String(count);
            } else {
                badge.hidden = true;
                badge.textContent = "0";
            }

            list.innerHTML = "";

            const items = (data && Array.isArray(data.items)) ? data.items : [];
            if (!items.length) {
                const empty = document.createElement("div");
                empty.className = "notif-empty";
                empty.textContent = "No notifications";
                list.appendChild(empty);
                return;
            }

            items.forEach((item) => {
                const hasCourse = !!item.course_slug;
                const row = document.createElement(hasCourse ? "a" : "div");
                row.className = "notif-item";
                row.textContent = item.message || "";

                if (hasCourse) {
                    row.href = `/courses/${item.course_slug}/`;
                }

                const notificationId = item.id;
                if (notificationId) {
                    row.addEventListener("click", (event) => {
                        event.stopPropagation();
                        const csrftoken = getCookie("csrftoken");
                        const url = `/courses/api/notifications/${notificationId}/read/`;
                        const hasTarget = !!item.course_slug;
                        const targetHref = hasTarget ? `/courses/${item.course_slug}/` : null;

                        // Prevent immediate navigation so we can reliably mark as read first.
                        if (hasTarget) {
                            event.preventDefault();
                        }

                        fetch(url, {
                            method: "POST",
                            credentials: "same-origin",
                            headers: {
                                "X-Requested-With": "XMLHttpRequest",
                                "X-CSRFToken": csrftoken || "",
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify({})
                        })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error("Failed to mark notification as read");
                                }
                                return response.json();
                            })
                            .then(() => {
                                if (targetHref) {
                                    window.location.href = targetHref;
                                } else {
                                    // Refresh notifications list and badge count.
                                    pollNotifications();
                                }
                            })
                            .catch((error) => {
                                console.error(error);
                                // On error, fall back to navigation if a target exists.
                                if (targetHref) {
                                    window.location.href = targetHref;
                                }
                            });
                    });
                }

                list.appendChild(row);
            });
        }

        function pollNotifications() {
            fetch("/courses/api/notifications/", {
                credentials: "same-origin",
                headers: {
                    "X-Requested-With": "XMLHttpRequest"
                }
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to fetch notifications");
                    }
                    return response.json();
                })
                .then((data) => {
                    renderNotifications(data);
                })
                .catch((error) => {
                    console.error(error);
                });
        }

        bellBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            const isHidden = dropdown.hasAttribute("hidden");
            if (isHidden) {
                dropdown.removeAttribute("hidden");
            } else {
                dropdown.setAttribute("hidden", "hidden");
            }
        });

        document.addEventListener("click", (event) => {
            if (!dropdown.hasAttribute("hidden")) {
                if (!dropdown.contains(event.target) && !bellBtn.contains(event.target)) {
                    dropdown.setAttribute("hidden", "hidden");
                }
            }
        });

        markAllBtn.addEventListener("click", () => {
            const csrftoken = getCookie("csrftoken");
            fetch("/courses/api/notifications/mark-all-read/", {
                method: "POST",
                credentials: "same-origin",
                headers: {
                    "X-Requested-With": "XMLHttpRequest",
                    "X-CSRFToken": csrftoken || ""
                },
                body: JSON.stringify({})
            })
                .then((response) => {
                    if (!response.ok) {
                        throw new Error("Failed to mark notifications as read");
                    }
                    // Refresh notifications after marking as read
                    pollNotifications();
                })
                .catch((error) => {
                    console.error(error);
                });
        });

        // Initial load and polling every 10 seconds
        pollNotifications();
        setInterval(pollNotifications, 10000);
    })();

    (function () {
        const userBtn = document.getElementById("user-menu-btn");
        const userDropdown = document.getElementById("user-dropdown");

        if (!userBtn || !userDropdown) {
            return;
        }

        userBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            const isHidden = userDropdown.hasAttribute("hidden");
            if (isHidden) {
                userDropdown.removeAttribute("hidden");
                userBtn.setAttribute("aria-expanded", "true");
            } else {
                userDropdown.setAttribute("hidden", "hidden");
                userBtn.setAttribute("aria-expanded", "false");
            }
        });

        document.addEventListener("click", (event) => {
            if (!userDropdown.hasAttribute("hidden")) {
                if (!userDropdown.contains(event.target) && !userBtn.contains(event.target)) {
                    userDropdown.setAttribute("hidden", "hidden");
                    userBtn.setAttribute("aria-expanded", "false");
                }
            }
        });
    })();
    </script>
    {% endif %}
</body>
</html>
